{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign featured_media = current_variant.featured_media | default: product.featured_media
-%}

<section class="product-page">
  <div class="container">
    <div class="product-page__grid">
      <!-- Product Gallery -->
      <div class="product-gallery">
        <div class="product-gallery__main" data-product-gallery>
          {%- for media in product.media -%}
            <div class="product-gallery__slide {% if media == featured_media %}is-active{% endif %}" data-media-id="{{ media.id }}">
              {%- case media.media_type -%}
                {%- when 'image' -%}
                  <img 
                    src="{{ media | image_url: width: 1200 }}"
                    srcset="{{ media | image_url: width: 600 }} 600w,
                            {{ media | image_url: width: 900 }} 900w,
                            {{ media | image_url: width: 1200 }} 1200w"
                    sizes="(max-width: 767px) 100vw, 50vw"
                    alt="{{ media.alt | escape | default: product.title }}"
                    loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                    class="product-gallery__image"
                  >
                {%- when 'video' -%}
                  {{ media | video_tag: autoplay: true, loop: true, muted: true, playsinline: true, class: 'product-gallery__video' }}
                {%- when 'external_video' -%}
                  {{ media | external_video_tag: class: 'product-gallery__video' }}
              {%- endcase -%}
            </div>
          {%- else -%}
            <div class="product-gallery__slide is-active">
              {{ 'product-1' | placeholder_svg_tag: 'product-gallery__placeholder' }}
            </div>
          {%- endfor -%}
        </div>

        {%- if product.media.size > 1 -%}
          <div class="product-gallery__thumbs">
            {%- for media in product.media -%}
              <button 
                type="button" 
                class="product-gallery__thumb {% if media == featured_media %}is-active{% endif %}"
                data-thumb="{{ media.id }}"
                aria-label="View {{ media.alt | default: 'image' }}"
              >
                <img 
                  src="{{ media | image_url: width: 100 }}"
                  alt="{{ media.alt | escape | default: product.title }}"
                  loading="lazy"
                  width="60"
                  height="80"
                >
              </button>
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>

      <!-- Product Info -->
      <div class="product-info">
        <div class="product-info__header">
          {%- if product.vendor -%}
            <p class="product-info__vendor">{{ product.vendor }}</p>
          {%- endif -%}
          <h1 class="product-info__title">{{ product.title }}</h1>
          <div class="product-info__price" data-product-price>
            {%- if current_variant.compare_at_price > current_variant.price -%}
              <span class="product-info__price-compare">{{ current_variant.compare_at_price | money }}</span>
              <span class="product-info__price-sale">{{ current_variant.price | money }}</span>
            {%- else -%}
              <span class="product-info__price-regular">{{ current_variant.price | money }}</span>
            {%- endif -%}
          </div>
        </div>

        {%- form 'product', product, id: 'product-form', class: 'product-form', data-product-form: '' -%}
          <input type="hidden" name="id" value="{{ current_variant.id }}" data-variant-id>

          {%- unless product.has_only_default_variant -%}
            {%- for option in product.options_with_values -%}
              <div class="product-option" data-option-index="{{ forloop.index0 }}">
                <div class="product-option__header">
                  <label class="product-option__label">
                    {{ option.name }}
                    <span class="product-option__selected" data-option-value>{{ option.selected_value }}</span>
                  </label>
                  {%- if option.name == 'Size' or option.name == 'Размер' -%}
                    <a href="/pages/size-guide" class="product-option__guide">Size Guide</a>
                  {%- endif -%}
                </div>

                {%- if option.name == 'Color' or option.name == 'Colour' or option.name == 'Цвет' -%}
                  <div class="product-option__colors">
                    {%- for value in option.values -%}
                      <button 
                        type="button"
                        class="product-option__color {% if option.selected_value == value %}is-active{% endif %}"
                        data-option-value="{{ value }}"
                        aria-label="{{ value }}"
                        style="background-color: {{ value | handleize }};"
                      >
                        <span class="visually-hidden">{{ value }}</span>
                      </button>
                    {%- endfor -%}
                  </div>
                {%- else -%}
                  <div class="product-option__buttons">
                    {%- for value in option.values -%}
                      <button 
                        type="button"
                        class="product-option__button {% if option.selected_value == value %}is-active{% endif %}"
                        data-option-value="{{ value }}"
                      >
                        {{ value }}
                      </button>
                    {%- endfor -%}
                  </div>
                {%- endif -%}
              </div>
            {%- endfor -%}
          {%- endunless -%}

          <!-- Quantity -->
          <div class="product-quantity">
            <label class="product-quantity__label">Quantity</label>
            <div class="product-quantity__selector" data-quantity>
              <button type="button" class="product-quantity__btn" data-quantity-minus aria-label="Decrease quantity">−</button>
              <input type="number" name="quantity" value="1" min="1" max="99" class="product-quantity__input" data-quantity-input>
              <button type="button" class="product-quantity__btn" data-quantity-plus aria-label="Increase quantity">+</button>
            </div>
          </div>

          <!-- Add to Cart -->
          <div class="product-actions">
            <button 
              type="submit" 
              class="product-actions__add-to-cart btn btn--primary btn--full"
              data-add-to-cart
              {% unless current_variant.available %}disabled{% endunless %}
            >
              {%- if current_variant.available -%}
                <span data-add-to-cart-text>Add to Cart</span>
              {%- else -%}
                <span>Sold Out</span>
              {%- endif -%}
            </button>

            <button type="button" class="product-actions__wishlist" aria-label="Add to wishlist">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
            </button>
          </div>
        {%- endform -%}

        <!-- Product Details Accordions -->
        <div class="product-details">
          <div class="product-accordion" data-accordion>
            <button type="button" class="product-accordion__trigger" data-accordion-trigger aria-expanded="true">
              <span>Description</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </button>
            <div class="product-accordion__content" data-accordion-content>
              <div class="product-accordion__text rte">
                {{ product.description }}
              </div>
            </div>
          </div>

          <div class="product-accordion" data-accordion>
            <button type="button" class="product-accordion__trigger" data-accordion-trigger aria-expanded="false">
              <span>Size & Fit</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </button>
            <div class="product-accordion__content" data-accordion-content style="max-height: 0;">
              <div class="product-accordion__text">
                <p>Model is 5'9" wearing size S</p>
                <p>True to size</p>
                <a href="/pages/size-guide">View Size Guide</a>
              </div>
            </div>
          </div>

          <div class="product-accordion" data-accordion>
            <button type="button" class="product-accordion__trigger" data-accordion-trigger aria-expanded="false">
              <span>Shipping & Returns</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </button>
            <div class="product-accordion__content" data-accordion-content style="max-height: 0;">
              <div class="product-accordion__text">
                <p><strong>Free shipping</strong> on orders over $150</p>
                <p><strong>Free returns</strong> within 30 days</p>
                <a href="/pages/shipping">Learn more</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="application/json" id="ProductJSON-{{ product.id }}">
  {{ product | json }}
</script>

<style>
.product-page {
  padding: calc(var(--header-height) + var(--announcement-height) + 20px) 0 80px;
}

.product-page .container {
  max-width: 1400px;
}

.product-page__grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 32px;
}

@media (min-width: 1024px) {
  .product-page__grid {
    grid-template-columns: 55% 40%;
    gap: 5%;
    align-items: start;
  }
}

/* Gallery */
.product-gallery {
  position: relative;
}

@media (min-width: 1024px) {
  .product-gallery {
    position: sticky;
    top: calc(var(--header-height) + var(--announcement-height) + 20px);
    align-self: start;
  }
}

.product-gallery__main {
  aspect-ratio: 3/4;
  overflow: hidden;
  background: #f8f8f8;
  position: relative;
  max-height: 55vh; /* Уменьшено с 75vh */
}

@media (min-width: 1024px) {
  .product-gallery__main {
    max-height: 60vh; /* Немного больше на десктопе */
  }
}

.product-gallery__slide {
  position: absolute;
  inset: 0;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.4s ease, visibility 0.4s;
}

.product-gallery__slide.is-active {
  opacity: 1;
  visibility: visible;
}

.product-gallery__image,
.product-gallery__video {
  width: 100%;
  height: 100%;
  object-fit: contain;
  object-position: center;
}

.product-gallery__placeholder {
  width: 100%;
  height: 100%;
}

/* Thumbnails - более заметные */
.product-gallery__thumbs {
  display: flex;
  flex-wrap: wrap; /* Перенос на новую строку */
  gap: 8px;
  margin-top: 20px;
  padding: 0;
}

@media (min-width: 768px) {
  .product-gallery__thumbs {
    gap: 10px;
  }
}

.product-gallery__thumb {
  flex-shrink: 0;
  width: 60px;
  height: 75px;
  overflow: hidden;
  border: 2px solid transparent;
  opacity: 0.7;
  transition: all 0.2s ease;
  background: #f8f8f8;
  cursor: pointer;
}

@media (min-width: 768px) {
  .product-gallery__thumb {
    width: 70px;
    height: 88px;
  }
}

@media (min-width: 1024px) {
  .product-gallery__thumb {
    width: 80px;
    height: 100px;
  }
}

.product-gallery__thumb.is-active,
.product-gallery__thumb:hover {
  opacity: 1;
  border-color: var(--color-foreground);
}

.product-gallery__thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Product Info */
.product-info {
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding-top: 20px;
}

@media (min-width: 1024px) {
  .product-info {
    padding-top: 0;
    max-width: 500px;
  }
}

.product-info__header {
  padding-bottom: 20px;
  border-bottom: 1px solid var(--color-border);
}

.product-info__vendor {
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--color-text-muted);
  margin-bottom: 8px;
}

.product-info__title {
  font-family: var(--font-body);
  font-size: 20px;
  font-weight: 400;
  line-height: 1.3;
  margin-bottom: 16px;
}

@media (min-width: 768px) {
  .product-info__title {
    font-size: 22px;
  }
}

.product-info__price {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 16px;
  font-weight: 400;
}

.product-info__price-compare {
  text-decoration: line-through;
  color: var(--color-text-muted);
}

.product-info__price-sale {
  color: #dc2626;
}

/* Product Options */
.product-option {
  padding-bottom: 20px;
}

.product-option__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.product-option__label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: 500;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.product-option__selected {
  font-weight: 400;
  text-transform: none;
  letter-spacing: 0;
  color: var(--color-text-muted);
}

.product-option__guide {
  font-size: 12px;
  font-weight: 400;
  text-decoration: underline;
  text-underline-offset: 2px;
  color: var(--color-text);
  transition: opacity 0.2s;
}

.product-option__guide:hover {
  opacity: 0.6;
}

.product-option__colors {
  display: flex;
  gap: 12px;
}

.product-option__color {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 1px solid #e0e0e0;
  outline: 2px solid transparent;
  outline-offset: 2px;
  transition: all 0.2s ease;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06);
}

/* White color needs visible border */
.product-option__color[style*="white"],
.product-option__color[style*="#fff"],
.product-option__color[style*="#ffffff"],
.product-option__color[aria-label*="White"],
.product-option__color[aria-label*="white"],
.product-option__color[aria-label*="Белый"],
.product-option__color[aria-label*="Ivory"],
.product-option__color[aria-label*="Cream"] {
  border-color: #d0d0d0;
}

.product-option__color.is-active {
  outline-color: var(--color-foreground);
  border-color: transparent;
}

.product-option__color:hover {
  outline-color: #999;
}

.product-option__color.is-active:hover {
  outline-color: var(--color-foreground);
}

.product-option__buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.product-option__button {
  min-width: 48px;
  padding: 12px 16px;
  border: 1px solid var(--color-border);
  font-size: 13px;
  transition: all 0.2s ease;
}

.product-option__button:hover {
  border-color: var(--color-foreground);
}

.product-option__button.is-active {
  background: var(--color-foreground);
  color: var(--color-background);
  border-color: var(--color-foreground);
}

.product-option__button:disabled {
  opacity: 0.4;
  text-decoration: line-through;
}

/* Quantity */
.product-quantity {
  padding-bottom: 24px;
}

.product-quantity__label {
  display: block;
  font-size: 12px;
  font-weight: 500;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 12px;
}

.product-quantity__selector {
  display: flex;
  border: 1px solid var(--color-border);
  width: fit-content;
}

.product-quantity__btn {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: background 0.2s ease;
}

.product-quantity__btn:hover {
  background: #f5f5f5;
}

.product-quantity__input {
  width: 60px;
  height: 48px;
  text-align: center;
  border: none;
  border-left: 1px solid var(--color-border);
  border-right: 1px solid var(--color-border);
  font-size: 15px;
  -moz-appearance: textfield;
}

.product-quantity__input::-webkit-outer-spin-button,
.product-quantity__input::-webkit-inner-spin-button {
  -webkit-appearance: none;
}

/* Actions */
.product-actions {
  display: flex;
  gap: 12px;
  align-items: stretch;
}

.product-actions__add-to-cart {
  flex: 1;
  padding: 16px 24px;
  font-size: 13px;
  font-weight: 500;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  background: var(--color-foreground);
  color: var(--color-background);
  border: 2px solid var(--color-foreground);
  transition: all 0.2s ease;
}

.product-actions__add-to-cart:hover {
  background: transparent;
  color: var(--color-foreground);
}

.product-actions__add-to-cart:disabled {
  background: #ccc;
  border-color: #ccc;
  cursor: not-allowed;
  color: #fff;
}

.product-actions__add-to-cart:disabled:hover {
  background: #ccc;
  color: #fff;
}

.product-actions__wishlist {
  width: 52px;
  min-height: 52px;
  border: 1px solid var(--color-border);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.product-actions__wishlist:hover {
  border-color: var(--color-foreground);
}

.product-actions__wishlist svg {
  transition: fill 0.2s ease;
}

.product-actions__wishlist:hover svg {
  fill: var(--color-foreground);
}

/* Accordions */
.product-details {
  border-top: 1px solid var(--color-border);
  margin-top: 16px;
}

.product-accordion {
  border-bottom: 1px solid var(--color-border);
}

.product-accordion__trigger {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 18px 0;
  font-size: 13px;
  font-weight: 500;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  text-align: left;
}

.product-accordion__trigger svg {
  transition: transform 0.3s ease;
}

.product-accordion__trigger[aria-expanded="true"] svg {
  transform: rotate(180deg);
}

.product-accordion__content {
  overflow: hidden;
  transition: max-height 0.3s ease;
}

.product-accordion__text {
  padding-bottom: 24px;
  font-size: 14px;
  line-height: 1.7;
  color: var(--color-text-muted);
}

.product-accordion__text p {
  margin-bottom: 12px;
}

.product-accordion__text a {
  text-decoration: underline;
  color: var(--color-text);
}

/* RTE */
.rte {
  font-size: 14px;
  line-height: 1.7;
  color: var(--color-text);
}

.rte h1, .rte h2, .rte h3, .rte h4, .rte h5, .rte h6 {
  margin-top: 20px;
  margin-bottom: 12px;
  font-weight: 600;
}

.rte h1:first-child, .rte h2:first-child, .rte h3:first-child {
  margin-top: 0;
}

.rte p {
  margin-bottom: 16px;
}

.rte p:last-child {
  margin-bottom: 0;
}

.rte ul, .rte ol {
  margin-bottom: 16px;
  padding-left: 20px;
}

.rte ul {
  list-style: disc;
}

.rte ol {
  list-style: decimal;
}

.rte li {
  margin-bottom: 8px;
  padding-left: 4px;
}

.rte strong, .rte b {
  font-weight: 600;
}

.rte a {
  color: var(--color-text);
  text-decoration: underline;
  text-underline-offset: 2px;
}

.rte a:hover {
  opacity: 0.7;
}

.rte table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 13px;
}

.rte table th,
.rte table td {
  padding: 10px 12px;
  border: 1px solid var(--color-border);
  text-align: left;
}

.rte table th {
  background: #f5f5f5;
  font-weight: 600;
}

.rte img {
  max-width: 100%;
  height: auto;
  margin: 16px 0;
}
</style>

<script>
(function() {
  const productSection = document.querySelector('.product-page');
  if (!productSection) return;

  const productId = {{ product.id }};
  const productJSON = JSON.parse(document.getElementById('ProductJSON-' + productId).textContent);
  
  const form = productSection.querySelector('[data-product-form]');
  const variantInput = form.querySelector('[data-variant-id]');
  const priceElement = productSection.querySelector('[data-product-price]');
  const addToCartBtn = form.querySelector('[data-add-to-cart]');
  const addToCartText = form.querySelector('[data-add-to-cart-text]');

  // Gallery
  const gallery = productSection.querySelector('[data-product-gallery]');
  const thumbs = productSection.querySelectorAll('[data-thumb]');
  
  thumbs.forEach(thumb => {
    thumb.addEventListener('click', function() {
      const mediaId = this.dataset.thumb;
      const slides = gallery.querySelectorAll('.product-gallery__slide');
      
      slides.forEach(slide => {
        slide.classList.toggle('is-active', slide.dataset.mediaId === mediaId);
      });
      
      thumbs.forEach(t => t.classList.remove('is-active'));
      this.classList.add('is-active');
    });
  });

  // Variant Selection
  const optionSelectors = productSection.querySelectorAll('.product-option__button, .product-option__color');
  
  optionSelectors.forEach(selector => {
    selector.addEventListener('click', function() {
      const option = this.closest('.product-option');
      const optionIndex = parseInt(option.dataset.optionIndex);
      const value = this.dataset.optionValue;
      
      // Update active state
      option.querySelectorAll('.product-option__button, .product-option__color').forEach(s => s.classList.remove('is-active'));
      this.classList.add('is-active');
      
      // Update selected value display
      option.querySelector('[data-option-value]').textContent = value;
      
      // Find matching variant
      const selectedOptions = [];
      productSection.querySelectorAll('.product-option').forEach((opt, idx) => {
        const activeBtn = opt.querySelector('.is-active');
        if (activeBtn) {
          selectedOptions[idx] = activeBtn.dataset.optionValue;
        }
      });
      
      const variant = productJSON.variants.find(v => {
        return v.options.every((opt, idx) => opt === selectedOptions[idx]);
      });
      
      if (variant) {
        updateVariant(variant);
      }
    });
  });

  function updateVariant(variant) {
    variantInput.value = variant.id;
    
    // Update price
    if (variant.compare_at_price && variant.compare_at_price > variant.price) {
      priceElement.innerHTML = `
        <span class="product-info__price-compare">${formatMoney(variant.compare_at_price)}</span>
        <span class="product-info__price-sale">${formatMoney(variant.price)}</span>
      `;
    } else {
      priceElement.innerHTML = `<span class="product-info__price-regular">${formatMoney(variant.price)}</span>`;
    }
    
    // Update button
    if (variant.available) {
      addToCartBtn.disabled = false;
      addToCartText.textContent = 'Add to Cart';
    } else {
      addToCartBtn.disabled = true;
      addToCartText.textContent = 'Sold Out';
    }
    
    // Update gallery image when variant changes
    updateGalleryForVariant(variant);
    
    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('variant', variant.id);
    window.history.replaceState({}, '', url);
  }

  function formatMoney(cents) {
    return '$' + (cents / 100).toFixed(2);
  }

  function updateGalleryForVariant(variant) {
    // In Shopify, variant.featured_image and media have different IDs
    // We need to match by image position or by comparing image URLs
    
    if (!variant.featured_image) {
      console.log('No featured image for variant', variant.title);
      return;
    }
    
    const slides = gallery.querySelectorAll('.product-gallery__slide');
    const variantImageSrc = variant.featured_image.src;
    
    // Extract filename from variant image src for comparison
    // Shopify URLs: //cdn.shopify.com/s/files/.../filename.jpg?v=123
    const getFilename = (url) => {
      if (!url) return '';
      // Remove query params and get filename
      return url.split('?')[0].split('/').pop().toLowerCase();
    };
    
    const variantFilename = getFilename(variantImageSrc);
    let foundIndex = -1;
    
    // Method 1: Try to find by image filename match
    slides.forEach((slide, index) => {
      const slideImg = slide.querySelector('img');
      if (slideImg) {
        const slideFilename = getFilename(slideImg.src);
        // Compare filenames (both should have same base name)
        if (slideFilename && variantFilename && 
            (slideFilename.includes(variantFilename.split('_')[0]) || 
             variantFilename.includes(slideFilename.split('_')[0]))) {
          foundIndex = index;
        }
      }
    });
    
    // Method 2: If not found, try by variant.featured_image.position
    if (foundIndex === -1 && variant.featured_image.position) {
      // Position is 1-indexed, array is 0-indexed
      foundIndex = variant.featured_image.position - 1;
    }
    
    // Method 3: Last resort - use variant position to guess image
    if (foundIndex === -1) {
      // Find variant index and use same index for image
      const variantIndex = productJSON.variants.findIndex(v => v.id === variant.id);
      if (variantIndex >= 0 && variantIndex < slides.length) {
        foundIndex = variantIndex;
      }
    }
    
    // Apply the change
    if (foundIndex >= 0 && foundIndex < slides.length) {
      slides.forEach((slide, index) => {
        slide.classList.toggle('is-active', index === foundIndex);
      });
      
      thumbs.forEach((thumb, index) => {
        thumb.classList.toggle('is-active', index === foundIndex);
      });
      
      console.log('Switched to image index:', foundIndex, 'for variant:', variant.title);
    }
  }

  // Quantity
  const quantityInput = form.querySelector('[data-quantity-input]');
  const minusBtn = form.querySelector('[data-quantity-minus]');
  const plusBtn = form.querySelector('[data-quantity-plus]');

  minusBtn?.addEventListener('click', () => {
    const value = parseInt(quantityInput.value) || 1;
    if (value > 1) quantityInput.value = value - 1;
  });

  plusBtn?.addEventListener('click', () => {
    const value = parseInt(quantityInput.value) || 1;
    if (value < 99) quantityInput.value = value + 1;
  });

  // Add to Cart
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(form);
    
    addToCartText.textContent = 'Adding...';
    addToCartBtn.disabled = true;
    
    try {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      });
      
      if (response.ok) {
        addToCartText.textContent = 'Added!';
        
        // Open cart drawer
        if (typeof window.openCartDrawer === 'function') {
          window.openCartDrawer();
        }
        
        // Update cart count
        updateCartCount();
        
        setTimeout(() => {
          addToCartText.textContent = 'Add to Cart';
          addToCartBtn.disabled = false;
        }, 1500);
      } else {
        throw new Error('Failed to add');
      }
    } catch (error) {
      addToCartText.textContent = 'Error';
      setTimeout(() => {
        addToCartText.textContent = 'Add to Cart';
        addToCartBtn.disabled = false;
      }, 1500);
    }
  });

  async function updateCartCount() {
    try {
      const response = await fetch('/cart.js');
      const cart = await response.json();
      document.querySelectorAll('[data-cart-count]').forEach(el => {
        el.textContent = cart.item_count;
      });
    } catch (error) {}
  }

  // Accordions
  productSection.querySelectorAll('[data-accordion-trigger]').forEach(trigger => {
    trigger.addEventListener('click', function() {
      const content = this.nextElementSibling;
      const isExpanded = this.getAttribute('aria-expanded') === 'true';
      
      this.setAttribute('aria-expanded', !isExpanded);
      content.style.maxHeight = isExpanded ? '0' : content.scrollHeight + 'px';
    });
  });
})();
</script>

{% schema %}
{
  "name": "Product Page",
  "tag": "section",
  "class": "section-product",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_sku",
      "label": "Show SKU",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_info",
      "label": "Enable sticky info on desktop",
      "default": true
    }
  ]
}
{% endschema %}
