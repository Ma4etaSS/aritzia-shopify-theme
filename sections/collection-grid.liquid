{%- comment -%}
  Collection Grid Section
  - Displays products from the collection page
  - Filters and sorting
  - Pagination
{%- endcomment -%}

{%- liquid
  assign products_per_page = section.settings.products_per_page | default: 24
-%}

<section class="collection-grid section">
  <div class="collection-grid__container container">
    
    {% comment %} Collection Header {% endcomment %}
    <div class="collection-grid__header">
      <div class="collection-grid__header-content">
        {%- if collection.description != blank and section.settings.show_description -%}
          <div class="collection-grid__description">{{ collection.description }}</div>
        {%- endif -%}
      </div>
      
      {% comment %} Toolbar {% endcomment %}
      <div class="collection-grid__toolbar">
        <div class="collection-grid__toolbar-left">
          {% comment %} Filter Toggle {% endcomment %}
          {%- if section.settings.enable_filtering -%}
            <button type="button" class="collection-grid__filter-toggle" data-filter-toggle>
              {% render 'icon-filter' %}
              <span>Filters</span>
            </button>
          {%- endif -%}
          
          {% comment %} Results Count {% endcomment %}
          <span class="collection-grid__count">
            {{ collection.products_count }} {{ collection.products_count | pluralize: 'product', 'products' }}
          </span>
        </div>
        
        {% comment %} Sort {% endcomment %}
        {%- if section.settings.enable_sorting -%}
          <div class="collection-grid__sort">
            <label for="SortBy" class="visually-hidden">Sort by</label>
            <select id="SortBy" class="collection-grid__sort-select" data-sort-select>
              {%- for option in collection.sort_options -%}
                <option value="{{ option.value }}"{% if option.value == collection.sort_by %} selected{% endif %}>
                  {{ option.name }}
                </option>
              {%- endfor -%}
            </select>
          </div>
        {%- endif -%}
      </div>
    </div>

    <div class="collection-grid__main">
      {% comment %} Filters Sidebar {% endcomment %}
      {%- if section.settings.enable_filtering -%}
        <aside class="collection-grid__filters" data-filters hidden>
          <div class="collection-grid__filters-header">
            <span class="collection-grid__filters-title">Filters</span>
            <button type="button" class="collection-grid__filters-close" data-filter-close>
              {% render 'icon-close' %}
            </button>
          </div>
          
          <form class="collection-grid__filters-form" data-filter-form>
            {%- for filter in collection.filters -%}
              <div class="collection-grid__filter" data-filter-group>
                <button 
                  type="button" 
                  class="collection-grid__filter-toggle-inner"
                  aria-expanded="true"
                  data-filter-accordion
                >
                  <span>{{ filter.label }}</span>
                  {% render 'icon-chevron-down' %}
                </button>
                
                <div class="collection-grid__filter-content" data-filter-content>
                  {%- case filter.type -%}
                    {%- when 'list' -%}
                      <ul class="collection-grid__filter-list" role="list">
                        {%- for value in filter.values -%}
                          <li class="collection-grid__filter-item">
                            <label class="collection-grid__filter-label">
                              <input 
                                type="checkbox"
                                name="{{ value.param_name }}"
                                value="{{ value.value }}"
                                {% if value.active %}checked{% endif %}
                                class="collection-grid__filter-checkbox"
                              >
                              <span class="collection-grid__filter-text">
                                {{ value.label }}
                                <span class="collection-grid__filter-count">({{ value.count }})</span>
                              </span>
                            </label>
                          </li>
                        {%- endfor -%}
                      </ul>
                    
                    {%- when 'price_range' -%}
                      <div class="collection-grid__filter-price">
                        <div class="collection-grid__filter-price-inputs">
                          <div class="collection-grid__filter-price-field">
                            <label for="Filter-{{ filter.label }}-GTE" class="visually-hidden">From</label>
                            <span class="collection-grid__filter-price-currency">{{ cart.currency.symbol }}</span>
                            <input
                              type="number"
                              id="Filter-{{ filter.label }}-GTE"
                              name="{{ filter.min_value.param_name }}"
                              value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"
                              placeholder="0"
                              min="0"
                              max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                              class="collection-grid__filter-price-input"
                            >
                          </div>
                          <span class="collection-grid__filter-price-separator">-</span>
                          <div class="collection-grid__filter-price-field">
                            <label for="Filter-{{ filter.label }}-LTE" class="visually-hidden">To</label>
                            <span class="collection-grid__filter-price-currency">{{ cart.currency.symbol }}</span>
                            <input
                              type="number"
                              id="Filter-{{ filter.label }}-LTE"
                              name="{{ filter.max_value.param_name }}"
                              value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"
                              placeholder="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                              min="0"
                              max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                              class="collection-grid__filter-price-input"
                            >
                          </div>
                        </div>
                      </div>
                  {%- endcase -%}
                </div>
              </div>
            {%- endfor -%}
            
            <div class="collection-grid__filters-actions">
              <button type="submit" class="btn btn-primary">Apply Filters</button>
              {%- if collection.filters != empty -%}
                <a href="{{ collection.url }}" class="btn btn-text">Clear All</a>
              {%- endif -%}
            </div>
          </form>
        </aside>
      {%- endif -%}

      {% comment %} Products Grid {% endcomment %}
      <div class="collection-grid__products">
        {%- if collection.products.size > 0 -%}
          <div class="product-grid">
            {%- paginate collection.products by products_per_page -%}
              {%- for product in collection.products -%}
                <div class="product-grid__item">
                  {% render 'product-card', 
                    product: product,
                    show_vendor: section.settings.show_vendor,
                    show_secondary_image: section.settings.show_secondary_image,
                    show_quick_add: section.settings.show_quick_add,
                    lazy_load: true
                  %}
                </div>
              {%- endfor -%}
            {%- endpaginate -%}
          </div>
          
          {% comment %} Pagination {% endcomment %}
          {%- paginate collection.products by products_per_page -%}
            {%- if paginate.pages > 1 -%}
              <nav class="collection-grid__pagination" aria-label="Pagination">
                <ul class="pagination" role="list">
                  {%- if paginate.previous -%}
                    <li class="pagination__item">
                      <a href="{{ paginate.previous.url }}" class="pagination__link pagination__link--prev" aria-label="Previous page">
                        {% render 'icon-chevron-left' %}
                      </a>
                    </li>
                  {%- endif -%}
                  
                  {%- for part in paginate.parts -%}
                    <li class="pagination__item">
                      {%- if part.is_link -%}
                        <a href="{{ part.url }}" class="pagination__link">{{ part.title }}</a>
                      {%- else -%}
                        {%- if part.title == paginate.current_page -%}
                          <span class="pagination__link pagination__link--current" aria-current="page">{{ part.title }}</span>
                        {%- else -%}
                          <span class="pagination__link">{{ part.title }}</span>
                        {%- endif -%}
                      {%- endif -%}
                    </li>
                  {%- endfor -%}
                  
                  {%- if paginate.next -%}
                    <li class="pagination__item">
                      <a href="{{ paginate.next.url }}" class="pagination__link pagination__link--next" aria-label="Next page">
                        {% render 'icon-chevron-right' %}
                      </a>
                    </li>
                  {%- endif -%}
                </ul>
              </nav>
            {%- endif -%}
          {%- endpaginate -%}
        {%- else -%}
          <div class="collection-grid__empty">
            <p>No products found in this collection.</p>
            <a href="{{ routes.all_products_collection_url }}" class="btn btn-primary">Browse All Products</a>
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
</section>

<style>
  .collection-grid {
    padding: var(--space-8) 0 var(--spacing-sections);
  }

  .collection-grid__header {
    margin-bottom: var(--space-6);
  }

  .collection-grid__description {
    max-width: 800px;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .collection-grid__toolbar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-4);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--color-border-light);
  }

  .collection-grid__toolbar-left {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .collection-grid__filter-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    background: none;
    border: 1px solid var(--color-border-dark);
    cursor: pointer;
    transition: background-color var(--transition-fast);
  }

  .collection-grid__filter-toggle:hover {
    background-color: var(--color-bg-secondary);
  }

  .collection-grid__filter-toggle svg {
    width: 16px;
    height: 16px;
  }

  .collection-grid__count {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .collection-grid__sort-select {
    min-width: 150px;
    padding: var(--space-2) var(--space-8) var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border-dark);
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23000' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right var(--space-3) center;
    background-size: 12px;
    appearance: none;
    cursor: pointer;
  }

  .collection-grid__main {
    display: flex;
    gap: var(--space-8);
    align-items: flex-start;
  }

  /* Filters */
  .collection-grid__filters {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 100%;
    max-width: 350px;
    background-color: var(--color-white);
    z-index: var(--z-modal);
    transform: translateX(-100%);
    transition: transform var(--transition-slow);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }

  .collection-grid__filters[hidden] {
    display: flex;
  }

  .collection-grid__filters.is-active {
    transform: translateX(0);
  }

  @media (min-width: 1024px) {
    .collection-grid__filters {
      position: sticky;
      top: calc(var(--header-height) + var(--space-4));
      width: 250px;
      max-width: none;
      flex-shrink: 0;
      transform: none;
      z-index: auto;
    }

    .collection-grid__filters[hidden] {
      display: none;
    }

    .collection-grid__filters.is-active,
    .collection-grid__filters:not([hidden]) {
      display: flex;
    }
  }

  .collection-grid__filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4) var(--space-6);
    border-bottom: 1px solid var(--color-border-light);
  }

  @media (min-width: 1024px) {
    .collection-grid__filters-header {
      display: none;
    }
  }

  .collection-grid__filters-title {
    font-size: var(--text-lg);
    font-weight: var(--font-medium);
    text-transform: uppercase;
  }

  .collection-grid__filters-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: none;
    border: none;
    cursor: pointer;
  }

  .collection-grid__filters-close svg {
    width: 20px;
    height: 20px;
  }

  .collection-grid__filters-form {
    flex: 1;
    padding: var(--space-4);
  }

  @media (min-width: 1024px) {
    .collection-grid__filters-form {
      padding: 0;
    }
  }

  .collection-grid__filter {
    border-bottom: 1px solid var(--color-border-light);
    padding: var(--space-4) 0;
  }

  .collection-grid__filter-toggle-inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 0;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wide);
    background: none;
    border: none;
    cursor: pointer;
  }

  .collection-grid__filter-toggle-inner svg {
    width: 12px;
    height: 12px;
    transition: transform var(--transition-fast);
  }

  .collection-grid__filter-toggle-inner[aria-expanded="false"] svg {
    transform: rotate(-90deg);
  }

  .collection-grid__filter-content {
    margin-top: var(--space-3);
  }

  .collection-grid__filter-toggle-inner[aria-expanded="false"] + .collection-grid__filter-content {
    display: none;
  }

  .collection-grid__filter-list {
    list-style: none;
    max-height: 300px;
    overflow-y: auto;
  }

  .collection-grid__filter-item {
    margin-bottom: var(--space-2);
  }

  .collection-grid__filter-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    cursor: pointer;
  }

  .collection-grid__filter-checkbox {
    width: 16px;
    height: 16px;
    accent-color: var(--color-black);
  }

  .collection-grid__filter-text {
    font-size: var(--text-sm);
  }

  .collection-grid__filter-count {
    color: var(--color-text-muted);
  }

  .collection-grid__filter-price-inputs {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .collection-grid__filter-price-field {
    display: flex;
    align-items: center;
    border: 1px solid var(--color-border-medium);
    padding: var(--space-2);
  }

  .collection-grid__filter-price-currency {
    color: var(--color-text-muted);
    font-size: var(--text-sm);
  }

  .collection-grid__filter-price-input {
    width: 60px;
    border: none;
    padding: 0 var(--space-2);
    font-size: var(--text-sm);
  }

  .collection-grid__filter-price-input:focus {
    outline: none;
  }

  .collection-grid__filter-price-separator {
    color: var(--color-text-muted);
  }

  .collection-grid__filters-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    padding-top: var(--space-4);
  }

  /* Products */
  .collection-grid__products {
    flex: 1;
    min-width: 0;
  }

  .collection-grid__empty {
    text-align: center;
    padding: var(--space-16) 0;
  }

  .collection-grid__empty p {
    margin-bottom: var(--space-6);
    color: var(--color-text-secondary);
  }

  /* Pagination */
  .collection-grid__pagination {
    margin-top: var(--space-10);
  }

  .pagination {
    display: flex;
    justify-content: center;
    gap: var(--space-1);
    list-style: none;
  }

  .pagination__link {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
    padding: 0 var(--space-2);
    font-size: var(--text-sm);
    border: 1px solid transparent;
    transition: border-color var(--transition-fast);
  }

  .pagination__link:hover {
    border-color: var(--color-border-dark);
    opacity: 1;
  }

  .pagination__link--current {
    border-color: var(--color-border-dark);
    font-weight: var(--font-medium);
  }

  .pagination__link svg {
    width: 16px;
    height: 16px;
  }
</style>

{% schema %}
{
  "name": "Collection grid",
  "class": "section-collection-grid",
  "settings": [
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 12,
      "max": 48,
      "step": 12,
      "default": 24
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show collection description",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Enable filtering",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "label": "Enable sorting",
      "default": true
    },
    {
      "type": "header",
      "content": "Product cards"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "label": "Show secondary image on hover",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_quick_add",
      "label": "Show quick add button",
      "default": true
    }
  ]
}
{% endschema %}
